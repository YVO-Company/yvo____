import{t as e}from"./lock-DSGmDFD7.js";import{t}from"./plus-CEMkcid2.js";import{t as n}from"./save-Du0TzjDU.js";import{t as r}from"./trash-2-Eo-Zwxxt.js";import{c as i,g as a,m as o,n as s,r as c,w as l,y as u}from"./index-FG9feFxU.js";import{t as d}from"./InvoiceRenderer-DjfAepaN.js";var f=i(`lock-open`,[[`rect`,{width:`18`,height:`11`,x:`3`,y:`11`,rx:`2`,ry:`2`,key:`1w4ew1`}],[`path`,{d:`M7 11V7a5 5 0 0 1 9.9-1`,key:`1mm8w8`}]]),p=i(`printer`,[[`path`,{d:`M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2`,key:`143wyd`}],[`path`,{d:`M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6`,key:`1itne7`}],[`rect`,{x:`6`,y:`14`,width:`12`,height:`8`,rx:`1`,key:`1ue0tg`}]]),m=l(u(),1),h=c();function g({invoiceId:i,onClose:c}){let l=o(),{id:u}=a(),g=i||u,[_,v]=(0,m.useState)([]),[ee,y]=(0,m.useState)(!0),[b,x]=(0,m.useState)(!g),[te,ne]=(0,m.useState)(``),[S,C]=(0,m.useState)(null),[w,T]=(0,m.useState)([]),[E,D]=(0,m.useState)(!1),[O,k]=(0,m.useState)(``),[A,j]=(0,m.useState)(10),[M,N]=(0,m.useState)(null),[P,F]=(0,m.useState)(``),[I,L]=(0,m.useState)(``),[R,z]=(0,m.useState)({invoiceNumber:`INV-${Date.now().toString().slice(-6)}`,customerName:``,clientAddress:``,gstNumber:``,date:new Date().toISOString().slice(0,10),dueDate:``,items:[],status:`DRAFT`,taxRate:10,customAttributes:[]});(0,m.useEffect)(()=>{W(),V(),B(),g&&H(g)},[g]);let B=async()=>{try{let e=localStorage.getItem(`companyId`);T((await s.get(`/invoice-templates`,{params:{companyId:e}})).data)}catch{console.error(`Failed to fetch templates`)}},V=async()=>{try{localStorage.getItem(`companyId`),C((await s.get(`/company/config`)).data.company)}catch{}},H=async e=>{try{let t=await s.get(`/invoices/${e}`);z(t.data),t.data.taxRate!==void 0&&j(t.data.taxRate),x(!1)}catch{console.error(`Failed to load invoice`)}},U=async()=>{let e=prompt(`Enter Invoice Security Password to Edit:`);if(e)try{let t=localStorage.getItem(`companyId`);(await s.post(`/company/verify-password`,{password:e,companyId:t})).data.valid?x(!0):alert(`Incorrect Password!`)}catch(e){console.error(e),alert(`Verification failed`)}},W=async()=>{try{let e=localStorage.getItem(`companyId`);v((await s.get(`/inventory`,{params:{companyId:e}})).data),y(!1)}catch(e){console.error(e)}},G=()=>{z(e=>({...e,items:[...e.items,{inventoryId:``,description:``,quantity:1,price:0,total:0}]}))},K=(e,t,n)=>{let r=[...R.items];if(r[e][t]=n,t===`inventoryId`){let t=_.find(e=>e._id===n);t&&(r[e].description=t.name,r[e].price=t.sellingPrice,r[e].inventoryId=t._id)}r[e].total=r[e].quantity*r[e].price,z({...R,items:r})},q=e=>{let t=R.items.filter((t,n)=>n!==e);z({...R,items:t})},J=()=>R.items.reduce((e,t)=>e+t.total,0),Y=J()*(A/100),X=J()+Y,Z=async()=>{if(!(!P||!I)){if(!(S?.invoiceAttributes||[]).includes(P))try{let e=localStorage.getItem(`companyId`),t=await s.post(`/company/invoice-attributes`,{companyId:e,attribute:P});C(e=>({...e,invoiceAttributes:t.data.invoiceAttributes}))}catch(e){console.error(`Failed to save new attribute to company`,e)}z(e=>({...e,customAttributes:[...e.customAttributes||[],{key:P,value:I}]})),F(``),L(``)}},Q=async(e=`DRAFT`)=>{try{let t=localStorage.getItem(`companyId`),n={...R,companyId:t,status:e,grandTotal:X,taxRate:A};g?await s.patch(`/invoices/${g}`,n):await s.post(`/invoices`,n),alert(`Invoice ${e===`DRAFT`?`saved`:`created`} successfully!`),c?(c(),window.location.reload()):l(`/dashboard/finance`)}catch(e){console.error(e),alert(`Failed to save invoice: `+(e.response?.data?.message||e.message))}},$=async()=>{if(!O)return alert(`Please enter a template name`);try{let e={companyId:localStorage.getItem(`companyId`),name:O,type:`COMPANY`,items:R.items.map(e=>({description:e.description,quantity:e.quantity,price:e.price,total:e.total})),taxRate:A};await s.post(`/invoice-templates`,e),alert(`Template saved successfully!`),D(!1),k(``),B()}catch(e){console.error(e),alert(`Failed to save template`)}},re=e=>{if(!e)return;let t=w.find(t=>t._id===e);t&&(z(e=>({...e,items:t.items&&t.items.length>0?t.items.map(e=>({...e,inventoryId:``})):e.items})),j(t.taxRate===void 0?10:t.taxRate),N(t.layout&&t.layout.length>0?t.layout:null))};return(0,h.jsxs)(`div`,{className:`flex flex-col lg:flex-row gap-6 h-[calc(100vh-100px)]`,children:[(0,h.jsxs)(`div`,{className:`w-full lg:w-1/3 bg-white border border-slate-200 rounded-xl p-6 overflow-y-auto print:hidden`,children:[(0,h.jsxs)(`div`,{className:`flex justify-between items-center mb-4`,children:[(0,h.jsx)(`h2`,{className:`text-lg font-bold text-slate-800`,children:`Invoice Settings`}),b?(0,h.jsxs)(`span`,{className:`text-green-600 flex items-center gap-1 text-xs font-medium bg-green-50 px-2 py-1 rounded`,children:[(0,h.jsx)(f,{size:14}),` Editing Mode`]}):(0,h.jsxs)(`button`,{onClick:U,className:`text-indigo-600 flex items-center gap-1 text-sm font-medium hover:underline`,children:[(0,h.jsx)(e,{size:14}),` Unlock to Edit`]})]}),(0,h.jsxs)(`div`,{className:`mb-4`,children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Load from Template`}),(0,h.jsxs)(`select`,{className:`w-full p-2 border rounded`,onChange:e=>re(e.target.value),disabled:!b,children:[(0,h.jsx)(`option`,{value:``,children:`-- Select a Template --`}),w.map(e=>(0,h.jsxs)(`option`,{value:e._id,children:[e.name,` `,e.type===`GLOBAL`?`(Global)`:``]},e._id))]})]}),(0,h.jsxs)(`div`,{className:`space-y-4`,children:[(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Invoice Number`}),(0,h.jsx)(`input`,{type:`text`,className:`w-full p-2 border rounded`,value:R.invoiceNumber,onChange:e=>z({...R,invoiceNumber:e.target.value}),disabled:!b})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Customer Name`}),(0,h.jsx)(`input`,{type:`text`,className:`w-full p-2 border rounded`,value:R.customerName,onChange:e=>z({...R,customerName:e.target.value}),disabled:!b})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Client Address`}),(0,h.jsx)(`textarea`,{className:`w-full p-2 border rounded`,value:R.clientAddress,onChange:e=>z({...R,clientAddress:e.target.value}),disabled:!b,rows:2})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`GST / Tax ID`}),(0,h.jsx)(`input`,{type:`text`,className:`w-full p-2 border rounded`,value:R.gstNumber,onChange:e=>z({...R,gstNumber:e.target.value}),disabled:!b})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Tax Rate (%)`}),(0,h.jsxs)(`div`,{className:`flex gap-2`,children:[(0,h.jsx)(`input`,{type:`number`,className:`w-full p-2 border rounded`,value:A,onChange:e=>j(parseFloat(e.target.value)||0),disabled:!b}),b&&(0,h.jsx)(`button`,{onClick:()=>j(0),className:`px-3 py-2 text-xs bg-red-50 text-red-600 rounded border border-red-200 hover:bg-red-100 whitespace-nowrap`,children:`Remove Tax`})]})]}),(0,h.jsxs)(`div`,{className:`grid grid-cols-2 gap-4`,children:[(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Date`}),(0,h.jsx)(`input`,{type:`date`,className:`w-full p-2 border rounded`,value:R.date,onChange:e=>z({...R,date:e.target.value})})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`block text-sm font-medium text-slate-700 mb-1`,children:`Due Date`}),(0,h.jsx)(`input`,{type:`date`,className:`w-full p-2 border rounded`,value:R.dueDate,onChange:e=>z({...R,dueDate:e.target.value})})]})]}),(0,h.jsxs)(`div`,{className:`mt-6 border-t border-slate-200 pt-6`,children:[(0,h.jsx)(`div`,{className:`flex justify-between items-center mb-4`,children:(0,h.jsx)(`h3`,{className:`font-semibold text-slate-800`,children:`Custom Attributes`})}),(0,h.jsx)(`div`,{className:`space-y-3 mb-4`,children:R.customAttributes?.map((e,t)=>(0,h.jsxs)(`div`,{className:`flex gap-2 items-center bg-slate-50 p-2 rounded`,children:[(0,h.jsx)(`div`,{className:`flex-1 text-sm font-semibold text-slate-700`,children:e.key}),(0,h.jsx)(`div`,{className:`flex-1 text-sm text-slate-600`,children:e.value}),(0,h.jsx)(`button`,{onClick:()=>{let e=[...R.customAttributes||[]];e.splice(t,1),z({...R,customAttributes:e})},className:`text-red-500 hover:text-red-700`,children:(0,h.jsx)(r,{size:16})})]},t))}),b&&(0,h.jsxs)(`div`,{className:`flex gap-2`,children:[(0,h.jsx)(`input`,{type:`text`,list:`company-attributes`,className:`flex-1 p-2 border rounded text-sm focus:ring-1 focus:ring-indigo-500 outline-none`,placeholder:`Name (e.g. E-way Bill)`,value:P,onChange:e=>F(e.target.value)}),(0,h.jsx)(`datalist`,{id:`company-attributes`,children:S?.invoiceAttributes?.map((e,t)=>(0,h.jsx)(`option`,{value:e},t))}),(0,h.jsx)(`input`,{type:`text`,className:`flex-1 p-2 border rounded text-sm focus:ring-1 focus:ring-indigo-500 outline-none`,placeholder:`Value`,value:I,onChange:e=>L(e.target.value)}),(0,h.jsx)(`button`,{onClick:Z,className:`p-2 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100`,children:(0,h.jsx)(t,{size:18})})]})]})]}),(0,h.jsxs)(`div`,{className:`mt-8`,children:[(0,h.jsxs)(`div`,{className:`flex justify-between items-center mb-4`,children:[(0,h.jsx)(`h3`,{className:`font-semibold text-slate-800`,children:`Items`}),(0,h.jsxs)(`button`,{onClick:G,className:`text-indigo-600 text-sm font-medium flex items-center gap-1 hover:underline`,children:[(0,h.jsx)(t,{size:16}),` Add Item`]})]}),(0,h.jsx)(`div`,{className:`space-y-4`,children:R.items.map((e,t)=>(0,h.jsxs)(`div`,{className:`bg-slate-50 p-3 rounded-lg border border-slate-200 relative group`,children:[(0,h.jsx)(`button`,{onClick:()=>q(t),className:`absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity`,children:(0,h.jsx)(r,{size:16})}),(0,h.jsxs)(`div`,{className:`mb-2`,children:[(0,h.jsx)(`label`,{className:`text-xs text-slate-500`,children:`Product`}),(0,h.jsxs)(`select`,{className:`w-full p-1.5 border rounded text-sm bg-white`,value:e.inventoryId,onChange:e=>K(t,`inventoryId`,e.target.value),children:[(0,h.jsx)(`option`,{value:``,children:`Select from Inventory...`}),_.map(e=>(0,h.jsxs)(`option`,{value:e._id,children:[e.name,` (₹`,e.sellingPrice,`)`]},e._id))]})]}),(0,h.jsxs)(`div`,{className:`grid grid-cols-3 gap-2`,children:[(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`text-xs text-slate-500`,children:`Qty`}),(0,h.jsx)(`input`,{type:`number`,className:`w-full p-1 border rounded text-sm`,value:e.quantity,onChange:e=>K(t,`quantity`,parseFloat(e.target.value)||0)})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`text-xs text-slate-500`,children:`Price`}),(0,h.jsx)(`input`,{type:`number`,className:`w-full p-1 border rounded text-sm`,value:e.price,onChange:e=>K(t,`price`,parseFloat(e.target.value)||0)})]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`label`,{className:`text-xs text-slate-500`,children:`Total`}),(0,h.jsxs)(`div`,{className:`text-sm font-medium pt-1.5 text-right`,children:[`₹`,e.total.toFixed(2)]})]})]})]},t))})]}),(0,h.jsxs)(`div`,{className:`mt-8 space-y-3 pt-6 border-t border-slate-200`,children:[b&&(0,h.jsxs)(`button`,{onClick:()=>D(!0),className:`w-full flex justify-center items-center gap-2 px-4 py-2 border border-slate-200 rounded-lg text-indigo-600 font-medium hover:bg-indigo-50`,children:[(0,h.jsx)(n,{size:18}),` Save as Template`]}),(0,h.jsxs)(`button`,{onClick:()=>Q(`DRAFT`),className:`w-full flex justify-center items-center gap-2 px-4 py-2 border border-slate-200 rounded-lg font-medium hover:bg-slate-50`,children:[(0,h.jsx)(n,{size:18}),` Save as Draft`]}),(0,h.jsxs)(`button`,{onClick:()=>Q(`PAID`),className:`w-full flex justify-center items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 shadow-sm`,children:[(0,h.jsx)(n,{size:18}),` Save & Record Sale`]})]})]}),E&&(0,h.jsx)(`div`,{className:`fixed inset-0 bg-black/50 flex items-center justify-center z-50`,children:(0,h.jsxs)(`div`,{className:`bg-white rounded-xl p-6 w-full max-w-sm`,children:[(0,h.jsx)(`h2`,{className:`text-lg font-bold mb-4`,children:`Save as Template`}),(0,h.jsx)(`input`,{type:`text`,className:`w-full p-2 border rounded mb-4`,placeholder:`Template Name (e.g., Monthly Services)`,value:O,onChange:e=>k(e.target.value)}),(0,h.jsxs)(`div`,{className:`flex justify-end gap-2`,children:[(0,h.jsx)(`button`,{onClick:()=>D(!1),className:`px-4 py-2 text-slate-500`,children:`Cancel`}),(0,h.jsx)(`button`,{onClick:$,className:`px-4 py-2 bg-indigo-600 text-white rounded`,children:`Save`})]})]})}),(0,h.jsxs)(`div`,{className:`flex-1 bg-slate-100 rounded-xl p-8 overflow-y-auto flex flex-col items-center print:bg-white print:p-0 print:block`,children:[(0,h.jsx)(d,{layout:M,invoiceData:R,companyConfig:S,taxRate:A,calculateSubtotal:J,tax:Y,total:X}),(0,h.jsxs)(`div`,{className:`mt-6 flex gap-4 print:hidden`,children:[(0,h.jsxs)(`button`,{onClick:()=>{window.print()},className:`flex items-center gap-2 px-6 py-3 bg-slate-900 text-white rounded-full font-bold hover:bg-slate-800 shadow-xl shadow-slate-200 hover:shadow-2xl transition-all transform hover:-translate-y-0.5`,children:[(0,h.jsx)(p,{size:18}),` Print Invoice`]}),(0,h.jsxs)(`button`,{onClick:()=>Q(R.status),className:`flex items-center gap-2 px-6 py-3 bg-white text-slate-700 border border-slate-200 rounded-full font-bold hover:bg-slate-50 shadow-sm transition-all`,children:[(0,h.jsx)(n,{size:18}),` Quick Save`]})]})]})]})}export{g as t};